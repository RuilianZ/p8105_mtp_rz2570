---
title: "p8105_mtp_rz2570"
author: "Ruilian Zhang"
date: "10/21/2021"
output: github_document
---

```{r}
library(tidyverse)
library(readxl)
library(ggpubr)

theme_set(theme_minimal() + theme(legend.position = "bottom"))
```


## Problem 1 - Data

```{r read and clean data}
horn_df = read_excel("data/p8105_mtp_data.xlsx", range = "A9:I1230") %>% 
  janitor::clean_names() %>% 
  mutate_at("eop_size_mm", ~replace(., is.na(.), 0)) %>% 
  mutate(sex = factor(sex),
         age_group = factor(age_group),
         eop_size = factor(eop_size),
         eop_visibility_classification = factor(eop_visibility_classification),
         eop_shape = factor(eop_shape),
         fhp_category = factor(fhp_category)
         )

horn_df %>% 
  group_by(sex, age_group) %>% 
  summarize(n = n()) %>%
  pivot_wider(names_from = age_group,
              values_from = n) %>% 
  mutate(sex = recode(sex, '0' = "Female", '1' = "Male")) %>% 
  knitr::kable()
```

* Fill the missing value in  `eop_size_mm` with `0`, factorize categorical variables.  
* `r ncol(horn_df)` related variables from `r nrow(horn_df)` participants form the data. Information includes sex, age,  size, visibility and shape of EOP, size and category of FHP. There are numeric and categorical variables respectively depicting EOP and FHP.  
* The distribution of age is generally the same across sex. 


```{r plot categorical variables}
a = horn_df %>% 
  ggplot(aes(x = eop_size)) +
  geom_bar()

b = horn_df %>% 
  ggplot(aes(x = eop_visibility_classification)) +
  geom_bar()

c = horn_df %>% 
  ggplot(aes(x = eop_shape)) +
  geom_bar()

d = horn_df %>% 
  ggplot(aes(x = fhp_category)) +
  geom_bar()

ggarrange(a, b, c, d)
```

* The `14.6` in `eop_size` and `30.8` in `fhp_category` do not correctly implement the definition based on underlying continuous variable `eop_size_mm` and `fhp_size_mm`. The rows of two erroneous value are respectively extracted as below.  
* `eop_visibility_classification` correctly implement the definition based on underlying continuous variable `eop_size_mm`.  
* There are some missing values in `eop_shape` which need to be addressed.  

```{r}
filter(horn_df, eop_size == "14.6")
filter(horn_df, fhp_category == "30.8")
```


## Problem 2 - Visualization

```{r improve original plots}
fhp_plot = horn_df %>% 
  filter(!(age_group == 1)) %>% 
  mutate(age_group = recode(age_group, `7` = "6", `8` = "6")) %>%
  ggplot(aes(x = age_group, y = fhp_size_mm, fill = sex)) +
  geom_boxplot() +
  labs(x = "Age group (years)",
       y = "Forward Head Protraction Size (mm)") +
  scale_x_discrete(labels = c("18-29", "30's", "40's", "50's", "60+")) +
  scale_fill_discrete(name = "Sex", labels = c("Female", "Male")) +
  labs(subtitle = "A")

eop_plot = horn_df %>% 
  filter(!(age_group == 1)) %>%
  mutate(age_group = recode(age_group, `7` = "6", `8` = "6")) %>% 
  mutate(eop_enlarged = ifelse(eop_size %in% c(0, 1), "non_enlarged", "enlarged")) %>% 
  group_by(sex, age_group, eop_enlarged) %>% 
  summarize(n_obs = n()) %>% 
  pivot_wider(
    names_from = eop_enlarged,
    values_from = n_obs) %>% 
  mutate_at("enlarged", ~replace(., is.na(.), 0)) %>% 
  mutate(enlarged_ratio = enlarged / (enlarged + non_enlarged)) %>%
  ggplot(aes(x = age_group, y = enlarged_ratio, group = sex, color = sex)) +
  geom_point() +
  geom_line() +
  labs(x = "Age group (years)",
       y = "Ratio of enlarged EOP") +
  scale_x_discrete(labels = c("18-29", "30's", "40's", "50's", "60+")) +
  scale_color_discrete(name = "Sex", labels = c("Female", "Male")) +
  labs(subtitle = "B")

ggarrange(fhp_plot, eop_plot)
```

* Filter out age group 1 since there are only two members in it, one of whom is misclassified by age, and the study is looking at age 18+.  
* The overall FHP size and ratio of having enlarged EPO are generally larger within male than female. There is an increasing trend of FHP size when the age increases, and the highest FHP size is found in people in their 70's. Age group 2 (18-30 age) has the highest ratio of enlarged EOP, while people in age group 1, 4 and 8 are less likely to have enlarged EOP.

```{r association between FHP size and EOP size}
horn_df %>% 
  filter(!(age_group == 1)) %>%
  mutate(
    sex = recode(sex, `0` = "Female", `1` = "Male"), 
    age_group = recode(age_group, `2` = "18-29", `3` = "30's", `4` = "40's", `5` = "50's", `6` = "60+", `7` = "60+", `8` = "60+")) %>%
  ggplot(aes(x = fhp_size_mm, y = eop_size_mm)) + 
  geom_point(color = "blue", size = 1, alpha = .8) +
  facet_grid(sex ~ age_group) +
  labs(subtitle = "C")
```

* The distribution of eop size against fhp size is not significantly different across age and sex groups, and there is no clear association between eop size and fhp size within each group.  

## Problem 3 – Reproducing reported results

```{r}
count(horn_df, age_group) %>% 
  knitr::kable()

horn_df %>% 
  group_by(sex) %>% 
  summarize(
    n_obs = n(),
    mean_fhp = mean(fhp_size_mm, na.rm = TRUE),
    sd_fhp = sd(fhp_size_mm, na.rm = TRUE),
    se_fhp = sd_fhp ^ 2 / sqrt(n_obs)) %>% 
  knitr::kable()

horn_df %>% 
  filter(!(eop_size == "14.6")) %>% 
  mutate(eeop = ifelse(as.numeric(eop_size) >= 2, 1, 0)) %>% 
  group_by(eeop) %>% 
  summarize(n_obs = n())

horn_df %>% 
  filter(!(age_group == 1)) %>%
  mutate(age_group = recode(age_group, `2` = "18-29", `3` = "30's", `4` = "40's", `5` = "50's", `6` = "60+", `7` = "60+", `8` = "60+")) %>% 
  ggplot(aes(x = age_group, y = fhp_size_mm)) +
  geom_bar(stat = "identity")
  

horn_df %>% 
  select(age, fhp_size_mm) %>% 
  drop_na() %>% 
  filter(age > 60) %>% 
  mutate(fhp_over_40 = ifelse(fhp_size_mm > 40, 1, 0)) %>% 
  group_by(fhp_over_40) %>% 
  summarize(n_obs = n())
```

* The authors’ stated sample sizes in each age group are  inconsistent with the data available.  
* The reported mean for FHP size is consistent with the data available, but standard deviations aren't the same.  
The authors find “the prevalence of EEOP to be 33% of the study population”. What is the definition of EEOP, and what variables can you use to evaluate this claim? Is the finding consistent with the data available to you?
* *EOP* is *enlarged external occipital protuberance*. The claim can be cacluated by `eop size`. Prevalence calculated by this data is 43%, which is different from 33%.  
* FHP is more common in people over 60. Specific value calculated with data is 32.6%.  

## Prblem 4

*Summarize your results, the quality of the data analysis / presentation of results in the original report, and comment on the conclusions of the reports’ authors. Do you think the data provide evidence that cell phones are causing horn growth? What other data would you like to have to address this hypothesis?*

